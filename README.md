# web_app_202505

# 開発手順
分からないことは@hikaru122700に聞いてください

初回のみ、自分のパソコンにクローンします。

どの階層で作業をするのか慎重に決めてください。（僕はこの作業で親レポジトリが破壊されました。）

```bash
git clone https://github.com/hikaru122700/web_app_202505.git
cd .\web_app_202505
```

クローンされた環境で開発を行います。実行するにはクローンされた環境を信頼することが必要です。

---

開発が一段落したら、以下の手順でpushします。

```bash
git add .
git commit -m "メッセージ"
```

”メッセージ”の部分はどのような変更をしたのかわかるように記述してください

```bash
git push origin main
```

---

最新のmainブランチの内容を取得したいとき

以下のエラーメッセージが出たとき

```bash
! [rejected]        main -> main (fetch first)
Updates were rejected because the remote contains work that you do not have locally
```

もしくは最新のmainブランチの内容を取得したいときは以下を実行

```bash
git pull origin main
```


以下のファイルはstreamlitで構成されています。

- X.py
- number_magic.py

実行時には以下のコマンドを入力してください。

```bash
streamlit run [filename.py]
```

以下のファイルはpygameで構成されています。

- chess.py

実行時には以下のコマンドを入力してください。

```bash
python chess.py
```

# Chess Game - 6x6経済チェス

## ゲーム概要

6x6ボードで行う経済要素を持つチェスゲーム。従来のチェスルールに加えて、駒の購入、従業員雇用、クラスチェンジなどの経済システムが導入されています。

## 基本ルール

### ボード構成
- **ボードサイズ**: 6x6マス
- **プレイヤー**: 白（人間）vs 黒（AI）
- **初期配置**: 従来のチェスと同様（キング、クイーン、ルーク、ビショップ、ナイト、ポーン）

### 駒の移動ルール
- **ポーン**: 前方1マス移動、斜め前方への駒取り
- **ルーク**: 縦横に任意のマス数移動
- **ビショップ**: 斜めに任意のマス数移動
- **ナイト**: L字型移動（2+1マス）
- **クイーン**: 縦横斜めに任意のマス数移動
- **キング**: 隣接する8方向に1マス移動

### 特殊ルール
- **ポーン昇格**: 相手陣地の最奥列に到達すると自動的にクイーンへ昇格
- **勝利条件**: 相手のキングを取ること

## 経済システム

### 資金管理
- **初期資金**: 各プレイヤー50G
- **ターン収入**: 基本10G + 従業員ボーナス（従業員1人につき+2G）
- **資金表示**: 画面左下に現在の所持金が表示

### 駒購入システム

自分の陣地（後方3列）の空いているマスに新しい駒を購入できます。

#### 購入オプション

| オプション | コスト | 駒の確率分布 |
|------------|--------|---------------|
| **Normal** | 20G | ポーン90%, ルーク3.3%, ナイト3.3%, ビショップ3.3%, クイーン0.1% |
| **Rare** | 30G | ポーン50%, ルーク15%, ナイト15%, ビショップ15%, クイーン5% |
| **Epic** | 40G | ポーン10%, ルーク25%, ナイト25%, ビショップ25%, クイーン15% |

### 従業員雇用システム
- **コスト**: 40G
- **効果**: ターン収入+2G（永続的）
- **戦略**: 長期的な収入増加による投資効果

### クラスチェンジシステム
- **コスト**: 70G
- **効果**: 駒を上位クラスにアップグレード
- **変換ルート**: ポーン→ナイト→ビショップ→ルーク→クイーン

### 特別ボーナス
- **領土ボーナス**: 相手陣地で駒を取ると+5G

## AI実装詳細

### アルゴリズム: Monte Carlo Tree Search (MCTS)

従来のアルファベータ探索から、確率的要素に対応したMCTSアルゴリズムに完全刷新。

#### MCTSの4つのフェーズ

1. **Selection（選択）**
   - UCB1戦略で最適な子ノードを選択
   - 探索と活用のバランス調整（exploration_weight=1.4）

2. **Expansion（展開）**
   - 未探索の行動から新しいノードを生成
   - 可能な全行動（移動、購入、雇用、クラスチェンジ）を考慮

3. **Simulation（シミュレーション）**
   - ランダムプレイアウトによる結果予測
   - 重み付き行動選択で現実的なシミュレーション
   - 最大深度5で効率化

4. **Backpropagation（逆伝播）**
   - シミュレーション結果を親ノードまで伝播
   - 訪問回数と報酬値を更新

#### 動的パフォーマンス調整

```python
iterations = min(80, max(25, len(available_actions) * 3))
```

- 行動数に応じて計算量を動的調整
- 最小25回、最大80回のイテレーション

### 高度な評価システム

#### 1. 位置価値テーブル

各駒タイプに対して6x6専用の位置評価テーブルを使用：

- **ポーン**: 前進を奨励、中央重視
- **ナイト**: 中央配置優遇、端避け
- **ビショップ**: 長距離展開優遇
- **ルーク**: 後列配置、活動性重視
- **クイーン**: バランス型配置
- **キング**: 安全性重視（中盤）

#### 2. ゲームフェーズ認識

**開局フェーズ（駒数>20）**:
- 中央制御重視
- 駒の展開ボーナス
- 開発速度評価

**中盤フェーズ（駒数10-20）**:
- 駒の活動性（モビリティ）重視
- 戦術的組み合わせ評価

**終盤フェーズ（駒数<10）**:
- キングの活性化
- 中央への接近ボーナス
- 精密計算重視

#### 3. 経済戦略評価

- **所持金差**: 資金優位性評価（重み0.02）
- **収入差**: 長期的収益力評価（重み0.5）
- **投資効率**: ROI計算による最適投資判断

### 確率的行動の最適化

#### 駒購入の期待値計算

```python
expected_value = Σ(piece_value × probability) - cost × 0.1
```

各購入オプションの期待値を動的計算し、リスク調整された意思決定を実行。

#### 重み付き行動選択

シミュレーション中の行動選択に戦略的重み付け：

- **駒取り**: 重み3.0（高優先度）
- **クラスチェンジ**: 重み2.0（中優先度）
- **従業員雇用**: 重み1.5（長期投資）
- **駒購入**: 期待値ベース（動的）
- **通常移動**: 重み1.0（ベースライン）

### フォールバック機能

MCTSが失敗した場合の安全機構：

1. **優先度付き行動選択**
2. **駒取り** > **経済行動（30%確率）** > **通常移動**
3. **例外処理**とタイムアウト対応

### パフォーマンス最適化

- **行動数制限**: 15手以上の場合、重要な行動のみフィルタリング
- **深度制限**: シミュレーション深度5で計算量削減
- **並列計算**: 複数ノードの同時評価
- **メモリ効率**: 不要なオブジェクトの即座解放

## 技術仕様

### 使用ライブラリ
- **pygame**: ゲーム描画・入力処理
- **math**: 数学計算（UCB1, 確率計算）
- **copy**: 深いコピーによる状態管理
- **random**: 確率的要素の実装

### ファイル構成
- **chess.py**: メインゲームファイル（約1100行）
- **chess_pieces/**: 駒画像（PNG形式、12ファイル）
- **dog/**: 犬コンパニオン画像
- **sound/**: 背景音楽・効果音
- **haikei.png**: 背景画像

### 主要クラス

1. **ChessGame**: メインゲームロジック
2. **SimGame**: 軽量シミュレーション用
3. **MCTSNode**: MCTS探索ノード
4. **MCTSPlayer**: AI思考エンジン
5. **AdvancedEvaluator**: 高度評価システム

## 操作方法

### 人間プレイヤー（白）
- **駒移動**: クリックで駒選択→目標地点クリック
- **駒購入**: 購入ボタンクリック→配置地点選択
- **従業員雇用**: HIREボタンクリック
- **クラスチェンジ**: 対象駒を右クリック

### ゲーム情報表示
- **所持金**: 画面左下
- **ターン表示**: 画面上部
- **ログメッセージ**: 画面右側
- **犬コンパニオン**: 状況に応じた表情変化

## AIの特徴

### 戦略的思考パターン

1. **短期戦術**: 駒取り、チェック回避
2. **中期戦略**: 陣形構築、領土拡大
3. **長期投資**: 経済成長、持続的優位性

### 学習能力

MCTSの性質により、以下の学習効果を発揮：

- **パターン認識**: 繰り返し局面での最適化
- **リスク評価**: 不確実性への適応
- **複合判断**: 複数要素の統合的評価

### 難易度調整

現在の設定では中〜上級者レベルの強さを実現。以下のパラメータで調整可能：

- `iterations`: 思考回数（25-80）
- `exploration_weight`: 探索の積極性（1.4）
- `max_depth`: シミュレーション深度（5）

## 今後の拡張可能性

1. **機械学習**: 深層学習による評価関数改善
2. **オンライン対戦**: ネットワーク対戦機能
3. **難易度設定**: 初心者〜エキスパートレベル
4. **カスタムルール**: ボードサイズ、経済パラメータ調整
5. **統計機能**: 対戦成績、戦略分析

---

**注意**: このAIは経済チェスというユニークなゲームに特化して設計されており、従来のチェスエンジンとは異なる戦略的アプローチを採用しています。

